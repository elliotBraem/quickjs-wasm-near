<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            background-color: black;
            font-family: monospace;
            font-size: 30px;
            color: white;
        }

        #container {
            margin: auto;
            margin-top: 20px;
            max-width: 1024px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        button {
            font-size: 30px;
            border: none;
            padding: 10px;
        }

        #imagediv img {
            max-width: 100%;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="infotext"></div>
        <div id="imagediv"></div>

        <button id="enterbutton">Enter</button>
    </div>
</body>
<script type="module">
    import 'https://cdn.jsdelivr.net/npm/near-api-js@0.44.2/dist/near-api-js.min.js';

    const contractAccount = 'apsolomo.testnet';

    const nearconfig = {
        nodeUrl: 'https://rpc.testnet.near.org',
        archiveNodeUrl: 'https://archival-rpc.testnet.near.org',
        walletUrl: 'https://wallet.testnet.near.org',
        helperUrl: 'https://helper.testnet.near.org',
        networkId: 'testnet',
        contractName: 'dev-1650702826986-24017505724534',
        deps: {
            keyStore: null
        }
    };

    const walletConnection = new Promise(async resolve => {
        nearconfig.deps.keyStore = new nearApi.keyStores.BrowserLocalStorageKeyStore();
        const near = await nearApi.connect(nearconfig);
        const wc = new nearApi.WalletConnection(near);
        resolve(wc);
    });

    function setInfoText(txt = '') {
        document.querySelector('#infotext').innerHTML = txt;
    }

    async function checkSignedin() {
        const wc = await walletConnection;
        const acc = wc.account();
        if (!(await acc.connection.signer.getPublicKey(acc.accountId, acc.connection.networkId))) {
            wc.signOut();
        }

        if (!wc.isSignedIn()) {
            await wc.requestSignIn(
                nearconfig.contractName,
                'js-on-near'
            );
        }
        return wc;
    }

    async function callJSContract(methodName, args = '') {
        const wc = await checkSignedin();
        const input = Buffer.concat([Buffer.from(contractAccount), Buffer.from([0]), Buffer.from(methodName), Buffer.from([0]), Buffer.from(JSON.stringify(args))]);
        try {
            const result = await wc.account().functionCall(nearconfig.contractName, 'call_js_contract', input);
            return result.status.SuccessValue ? atob(result.status.SuccessValue) : ''
        } catch (e) {
            if (e.message.indexOf('insufficient deposit for storage') > 0) {
                const result = await wc.account().functionCall(nearconfig.contractName, 'call_js_contract', input, undefined, nearApi.utils.format.parseNearAmount('0.1'));
                return result.status.SuccessValue ? atob(result.status.SuccessValue) : ''
            } else {
                throw (e);
            }
        }
    }

    async function viewJSContract(methodName, args = '') {
        const wc = await checkSignedin();
        const input = Buffer.concat([Buffer.from(contractAccount), Buffer.from([0]), Buffer.from(methodName), Buffer.from([0]), Buffer.from(JSON.stringify(args))]);
        const result = await wc._near.connection.provider.query({
            request_type: "call_function",
            account_id: nearconfig.contractName,
            method_name: 'view_js_contract',
            args_base64: btoa(input),
            finality: "optimistic"
        });
        const resultvalue = result.result.map(c => String.fromCharCode(c)).join('');
        return resultvalue;
    }

    async function checkTransactionIdInQueryString() {
        const wc = await walletConnection;
        const accountId = wc.account().accountId;
        if (accountId) {
            const transactionIdMatch = location.search.match(/transactionHashes=([a-zA-Z0-9]+)/);
            if (transactionIdMatch) {
                const txhash = transactionIdMatch[1];
                const result = (await fetch(nearconfig.nodeUrl, {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        "jsonrpc": "2.0",
                        "id": "dontcare",
                        "method": "EXPERIMENTAL_tx_status",
                        "params": [txhash, accountId]
                    })
                }).then(r => r.json())).result;

                console.log(result);
                setInfoText(`${result.status.SuccessValue ? atob(result.status.SuccessValue) : ''}`);
            }
        }
    }

    (async function () {
        await checkTransactionIdInQueryString();

        const enterbutton = document.getElementById('enterbutton');
        const imagediv = document.getElementById('imagediv');
        let currentStep = -1;
        enterbutton.addEventListener('click', async () => {
            enterbutton.style.display = 'none';
            setInfoText('Calling smart contract');
            if (await viewJSContract('hasgame') != 'true') {
                setInfoText('Creating new game');
                await callJSContract('newgame');
            }
            const result = JSON.parse(await callJSContract('nextstep', { currentStep }));
            currentStep = result.currentStep;

            const imageElement = new Image();
            imageElement.src = result.image;

            console.log(imageElement.src);
            imagediv.replaceChildren(imageElement);
            enterbutton.style.display = 'block';
            enterbutton.innerHTML = 'Next';
            setInfoText('');
        });
        imagediv.addEventListener('click', async (e) => {
            const x = Math.floor(e.offsetX * 3 / imagediv.clientWidth);
            const y = Math.floor(e.offsetY * 3 / imagediv.clientHeight);
            setInfoText('Trying to find key');
            const result = JSON.parse(await callJSContract('tryFindKey', { currentStep, x, y }));
            if (result.keyFound) {
                setInfoText(`Key found in ${result.attempts} attempts`);
            } else {
                setInfoText(`Key not found in ${result.attempts} attempts`);
            }
        });
    })();
</script>

</html>